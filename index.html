
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUVN - Registro de Cuidados</title>
    <meta name="description" content="Herramienta exclusiva para el equipo de cuidadores.">

    <meta property="og:type" content="website">
    <meta property="og:title" content="MUVN - Equipo de Cuidados">
    <meta property="og:description" content="Cuidar con el coraz√≥n hace la diferencia. ‚ù§Ô∏è Tu dedicaci√≥n transforma vidas cada d√≠a.">
    <meta property="og:image" content="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/MUVN-JMVN/refs/heads/main/muvn.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MUVN - Equipo de Cuidados">
    <meta name="twitter:description" content="Cuidar con el coraz√≥n hace la diferencia. ‚ù§Ô∏è Tu dedicaci√≥n transforma vidas cada d√≠a.">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/MUVN-JMVN/refs/heads/main/muvn.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 font-sans pb-20">

    <div id="root"></div>

    <script type="text/babel">
        // ---------------------------------------------------------
        // 1. CONFIGURACI√ìN DE FIREBASE
        // ---------------------------------------------------------
        // ¬°PEGA AQU√ç TU CONFIGURACI√ìN DE FIREBASE ENTRE LAS LLAVES!
        const firebaseConfig = {
            apiKey: "AIzaSyDmf2tlJYR7cP_vxv66tVozQDBFehURGXM",
            authDomain: "data-d064b.firebaseapp.com",
            projectId: "data-d064b",
            storageBucket: "data-d064b.firebasestorage.app",
            messagingSenderId: "15120958868",
            appId: "1:15120958868:web:ec1d059d08f631bb81fb81"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ---------------------------------------------------------
        // 2. COMPONENTES E ICONOS (Igual que antes)
        // ---------------------------------------------------------
        const Icons = {
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            CheckCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            ClipboardList: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            Heart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19h.5a3.5 3.5 0 1 0-1-6.429"/><path d="M6.5 19H6a4 4 0 1 1 .59-7.954"/><path d="M12 13.5V5"/><path d="m9 8 3-3 3 3"/></svg>
        };

        const CAREGIVERS = ["Ana Mart√≠nez", "Carlos Vel√°zquez", "Beatriz Sol√≠s", "David L√≥pez", "Elena Ram√≠rez"];

        const PATIENTS = [
            {
                id: 'p1', name: "Don Roberto (Diabetes/Hipertensi√≥n)", details: "Insulinodependiente.",
                tasks: {
                    dia: [ { id: 't1_d1', text: "Toma de Glucosa", type: "vital" }, { id: 't1_d2', text: "Insulina NPH", type: "med" }, { id: 't1_d3', text: "Desayuno", type: "food" } ],
                    noche: [ { id: 't1_n1', text: "Cena", type: "food" }, { id: 't1_n3', text: "Insulina Noche", type: "med" } ]
                }
            },
            {
                id: 'p2', name: "Do√±a Mar√≠a (Alzheimer)", details: "Desorientaci√≥n espacial.",
                tasks: {
                    dia: [ { id: 'p2_d1', text: "Memantina 10mg", type: "med" }, { id: 'p2_d2', text: "Aseo asistido", type: "hygiene" } ],
                    noche: [ { id: 'p2_n1', text: "Quetiapina (SOS)", type: "med" }, { id: 'p2_n2', text: "Barandales", type: "safety" } ]
                }
            }
        ];
        // (He resumido los pacientes para el ejemplo, pero t√∫ puedes pegar tu lista completa de vuelta aqu√≠)

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [caregiver, setCaregiver] = React.useState("");
            const [shift, setShift] = React.useState("");
            const [patientId, setPatientId] = React.useState("");
            const [records, setRecords] = React.useState({});
            const [status, setStatus] = React.useState("listo"); // listo, cargando, guardando

            // Obtener fecha actual en formato string simple para usar como ID (YYYY-MM-DD)
            const getTodayStr = () => {
                const now = new Date();
                return now.toISOString().split('T')[0]; 
            };

            // ---------------------------------------------------------
            // 3. L√ìGICA DE BASE DE DATOS (EFECTOS)
            // ---------------------------------------------------------
            
            // Cargar datos cuando cambie Paciente, Turno o Cuidador
            React.useEffect(() => {
                if(!patientId || !shift) {
                    setRecords({});
                    return;
                }

                const loadData = async () => {
                    setStatus("cargando");
                    const dateStr = getTodayStr();
                    // ID √öNICO DEL DOCUMENTO: fecha_turno_paciente
                    const docId = `${dateStr}_${shift}_${patientId}`;

                    try {
                        const docRef = db.collection("registros_diarios").doc(docId);
                        const docSnap = await docRef.get();

                        if (docSnap.exists) {
                            const data = docSnap.data();
                            setRecords(data.records || {});
                            if(data.caregiver) setCaregiver(data.caregiver);
                        } else {
                            setRecords({}); // Nuevo d√≠a/turno limpio
                        }
                    } catch (error) {
                        console.error("Error cargando:", error);
                        alert("Error de conexi√≥n. Verifica tu internet.");
                    } finally {
                        setStatus("listo");
                    }
                };

                loadData();

            }, [patientId, shift]);

            // Funci√≥n para guardar en Firestore
            const saveToFirestore = async (newRecords) => {
                if(!patientId || !shift) return;

                setStatus("guardando");
                const dateStr = getTodayStr();
                const docId = `${dateStr}_${shift}_${patientId}`;

                try {
                    await db.collection("registros_diarios").doc(docId).set({
                        date: dateStr,
                        shift: shift,
                        patientId: patientId,
                        caregiver: caregiver,
                        lastUpdate: new Date(),
                        records: newRecords
                    }, { merge: true }); // Merge evita borrar otros campos si agregamos m√°s cosas
                    
                    setStatus("listo");
                } catch (error) {
                    console.error("Error guardando:", error);
                    setStatus("error");
                }
            };

            // ---------------------------------------------------------
            // 4. MANEJADORES DE EVENTOS
            // ---------------------------------------------------------

            const handleTaskCheck = (taskId) => {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

                const newRecords = { ...records };
                const current = newRecords[taskId] || {};

                if (current.checked) {
                    newRecords[taskId] = { ...current, checked: false, time: null };
                } else {
                    newRecords[taskId] = { ...current, checked: true, time: timeString };
                }

                setRecords(newRecords);
                saveToFirestore(newRecords); // Guardar en nube inmediatamente
            };

            const handleTaskNote = (taskId, text) => {
                const newRecords = {
                    ...records,
                    [taskId]: { ...(records[taskId] || {}), note: text }
                };
                setRecords(newRecords);
                // Nota: para el texto, quiz√°s quieras usar un bot√≥n "guardar" o 'onBlur' 
                // para no escribir en base de datos con cada letra. 
                // Para simplificar, aqu√≠ guardamos al terminar de editar (onBlur en el input).
            };
            
            // Guardar nota cuando el usuario quita el foco del input
            const saveNoteOnBlur = () => {
                saveToFirestore(records);
            }

            const generateWhatsAppLink = () => {
                if (!caregiver || !shift || !patientId) {
                    alert("Faltan datos"); return;
                }
                const patient = PATIENTS.find(p => p.id === patientId);
                const taskList = patient.tasks[shift] || [];
                
                let message = `üìã *REPORTE ${shift.toUpperCase()} - MUVN*\n`;
                message += `üìÖ ${new Date().toLocaleDateString()} | üë§ ${caregiver}\n`;
                message += `üë¥ ${patient.name}\n\n`;
                
                taskList.forEach(task => {
                    const rec = records[task.id];
                    if (rec && rec.checked) {
                        message += `‚úÖ ${task.text} (${rec.time})\n`;
                        if (rec.note) message += `   üìù ${rec.note}\n`;
                    } else {
                        message += `‚≠ï ${task.text}`;
                         if (rec && rec.note) message += ` (Obs: ${rec.note})`;
                        message += `\n`;
                    }
                });

                const encodedMsg = encodeURIComponent(message);
                window.open(`https://wa.me/524451586270?text=${encodedMsg}`, '_blank');
            };

            const currentPatient = PATIENTS.find(p => p.id === patientId);
            const currentTasks = (currentPatient && shift) ? currentPatient.tasks[shift] : [];

            return (
                <div className="max-w-3xl mx-auto">
                    {/* HEADER */}
                    <header className="bg-sky-600 text-white p-4 shadow-md sticky top-0 z-10 rounded-b-xl flex justify-between items-center">
                         <div>
                            <h1 className="text-xl font-bold flex items-center gap-2"><Icons.Activity /> MUVN</h1>
                         </div>
                         <div className="text-xs font-mono bg-sky-700 px-2 py-1 rounded flex items-center gap-1">
                            {status === 'cargando' && <span className="animate-pulse">‚òÅÔ∏è Cargando...</span>}
                            {status === 'guardando' && <span className="animate-pulse">üíæ Guardando...</span>}
                            {status === 'listo' && <span>‚òÅÔ∏è En l√≠nea</span>}
                         </div>
                    </header>

                    <main className="p-4 space-y-6">
                        {/* SELECCI√ìN DE USUARIO */}
                        <section className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <label className="block text-sm font-semibold text-gray-600 mb-2">üë§ Cuidador</label>
                            <select value={caregiver} onChange={(e) => setCaregiver(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-lg">
                                <option value="">-- Selecciona --</option>
                                {CAREGIVERS.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </section>

                        {/* SELECCI√ìN DE TURNO */}
                        <section className="grid grid-cols-2 gap-4">
                            <button onClick={() => setShift('dia')} className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${shift === 'dia' ? 'border-amber-400 bg-amber-50' : 'bg-white'}`}>
                                <Icons.Sun /> <span className="font-bold">D√≠a</span>
                            </button>
                            <button onClick={() => setShift('noche')} className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 ${shift === 'noche' ? 'border-indigo-500 bg-indigo-50' : 'bg-white'}`}>
                                <Icons.Moon /> <span className="font-bold">Noche</span>
                            </button>
                        </section>

                         {/* SELECCI√ìN PACIENTE */}
                         <section className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                             <label className="block text-sm font-semibold text-gray-600 mb-2">üë¥ Paciente</label>
                             <div className="space-y-2">
                                {PATIENTS.map(p => (
                                    <button key={p.id} onClick={() => setPatientId(p.id)} className={`w-full text-left p-3 rounded-lg border ${patientId === p.id ? 'border-sky-500 bg-sky-50' : 'hover:bg-gray-50'}`}>
                                        <div className="font-bold">{p.name}</div>
                                    </button>
                                ))}
                             </div>
                        </section>

                        {/* LISTA DE TAREAS */}
                        {shift && patientId && (
                            <section className="space-y-4 animate-fade-in">
                                <h2 className="text-lg font-bold text-gray-800 border-b pb-2">Lista de Tareas</h2>
                                {currentTasks.map((task) => {
                                    const record = records[task.id] || {};
                                    const isChecked = record.checked || false;
                                    return (
                                        <div key={task.id} className={`bg-white rounded-lg shadow-sm border p-4 ${isChecked ? 'bg-gray-50' : ''}`}>
                                            <div className="flex items-center gap-3">
                                                <button onClick={() => handleTaskCheck(task.id)} className={`w-8 h-8 rounded-full border-2 flex items-center justify-center ${isChecked ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300'}`}>
                                                    <Icons.CheckCircle />
                                                </button>
                                                <div className="flex-1">
                                                    <h3 className={`font-medium ${isChecked ? 'line-through text-gray-400' : ''}`}>{task.text}</h3>
                                                    {isChecked && record.time && <div className="text-xs text-emerald-600">Completado: {record.time}</div>}
                                                </div>
                                            </div>
                                            <div className="mt-3 pl-11">
                                                <textarea 
                                                    placeholder="Notas..." 
                                                    value={record.note || ""} 
                                                    onChange={(e) => handleTaskNote(task.id, e.target.value)}
                                                    onBlur={saveNoteOnBlur} 
                                                    className="w-full text-sm p-2 border rounded bg-gray-50" rows={1} 
                                                />
                                            </div>
                                        </div>
                                    )
                                })}
                            </section>
                        )}
                    </main>

                     {/* FOOTER */}
                     {shift && patientId && (
                        <div className="fixed bottom-0 left-0 w-full bg-white border-t p-4 z-20">
                             <button onClick={generateWhatsAppLink} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow flex justify-center gap-2">
                                <Icons.Send /> Enviar Reporte
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
